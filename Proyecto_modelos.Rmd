---
title: "Proyecto Modelos"
author: "Alejandro Brenes, Santiago Fernández, Eyeri Méndez y Erick Venegas"
date: "`r Sys.Date()`"
output: html_document
---

Inicialmente, se obtienen las librarías necesarias para el desarrollo del proyecto.

```{r librerías}
pacman::p_load(tidyverse,
               dplyr,
               knitr)
```

# Bases desagregadas

Se prosigue descargando las bases de datos correspondientes.

```{r BD}
hungria <-
  read.table(
    "data/reprocessed.hungarian.data",
    header = FALSE,
    sep = " ",
    stringsAsFactors = FALSE
  )

suiza <-
  read.table(
    "data/processed.switzerland.data",
    header = FALSE,
    sep = ",",
    stringsAsFactors = FALSE
  )

lb <-
  read.table(
    "data/processed.va.data",
    header = FALSE,
    sep = ",",
    stringsAsFactors = FALSE
  )

cleveland <-
  read.table(
    "data/processed.cleveland.data",
    header = FALSE,
    sep = ",",
    stringsAsFactors = FALSE
  )
```

Luego, se ponen los nombres de las variables para identificarlas.

```{r nombres_col}
nombres.col <- c(
    "age",
    "sex",
    "cp",
    "trestbps",
    "chol",
    "fbs",
    "restecg",
    "thalach",
    "exang",
    "oldpeak",
    "slope",
    "ca",
    "thal",
    "num"
  )

colnames(hungria) <- nombres.col
  
colnames(cleveland) <- nombres.col

colnames(lb) <- nombres.col

colnames(suiza) <- nombres.col

rm(nombres.col)
```

Posteriormente, se corrigen los valores "?" presentes en las bases de datos.

```{r signos_pregunta}
for (i in 1:14) {
  lb[, i] <- ifelse(lb[, i] == "?", NA, lb[, i])
  cleveland[, i] <-
    ifelse(cleveland[, i] == "?", NA, cleveland[, i])
  hungria[, i] <- ifelse(hungria[, i] == "?", NA, hungria[, i])
  hungria[, i] <- ifelse(hungria[, i] == -9, NA, hungria[, i])
  suiza[, i] <- ifelse(suiza[, i] == "?", NA, suiza[, i])
}
```

Seguidamente, es importante notar que todos los datos son numéricos, por lo que se hacen las correcciones necesarias.

```{r tipo_columna}
# Datos numéricos
cleveland <- as.data.frame(sapply(cleveland, as.numeric))
lb <- as.data.frame(sapply(lb, as.numeric))
suiza <- as.data.frame(sapply(suiza, as.numeric))
hungria <- as.data.frame(sapply(hungria, as.numeric))

# Se elimina la observación nula de la base de Hungría
hungria <- hungria[-295,]
```

## Porcentajes de nulos

Ahora, procedemos a ver la cantidad de nulos por columna en cada base de datos.

```{r nulos}
# Creamos el DataFrame
nulos <-
  data.frame(
    "cleveland" = colSums(is.na(cleveland)),
    "long_beach" = colSums(is.na(lb)),
    "suiza" = colSums(is.na(suiza)),
    "hungria" = colSums(is.na(hungria))
  )

# Cambiamos el nombre de las filas
rownames(nulos) <- colnames(cleveland)

# Ponemos en porcentajes
nulos <-
  nulos / matrix(c(303, 200, 123, 295),
                 ncol = 4,
                 nrow = 14,
                 byrow = TRUE)

# Se omiten las variables que no tienen nulos en ninguna base de datos
nulos <- nulos[c(4:13),]

# Se pone una variable con el nombre de las variables
nulos$variable <- rownames(nulos)
```

Se procede a hacer un gráfico con el porcentaje de nulos, separado por base de datos.

```{r grafico_nulos}
# Se pone en formato largo
nulos <- nulos %>%
  pivot_longer(cols = -variable,
               names_to = "Origen",
               values_to = "Nulos")

# Se crea el gráfico
ggplot(nulos, aes(x = variable, y = (Nulos * 100), fill = Origen)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    values = c(
      "cleveland" = "#4A0A5D",
      "long_beach" = "#006992",
      "suiza" = "#00BC7F",
      "hungria" = "#D6E12D"
    ),
    labels = c(
      "cleveland" = "Cleveland",
      "long_beach" = "Long Beach",
      "suiza" = "Suiza",
      "hungria" = "Hungría"
    )
  ) +
  labs(x = "Variable",
       y = "Porcentaje de nulos") +
  theme_minimal()

# Se elimina la base de nulos, pues ya no se ocupa
rm(nulos)
```

# Bases agregadas

Una vez vistos los nulos, se procede a agregar un identificador para ver el origen de las observaciones. Luego, se juntan las bases de Estados Unidos (*Cleveland* y *Long beach*) y las de Europa (*Suiza* y *Hungría*) para tener datos más compactos.

```{r bases_agregadas, message = FALSE}
# Identificador por base
cleveland <- cleveland %>% mutate(origen = "Cleveland")
hungria <- hungria %>% mutate(origen = "Hungria")
lb <- lb %>% mutate(origen = "Long Beach")
suiza <- suiza %>% mutate(origen = "Suiza")

# Se juntan las bases agregadas
europa <- full_join(hungria, suiza)
eeuu <- full_join(cleveland, lb)

# Se corrige la variable respuesta en ambos casos
europa <- europa %>% mutate(num = ifelse(num >= 1, 1, 0))
eeuu <- eeuu %>% mutate(num = ifelse(num >= 1, 1, 0))

# La variable num es un factor
eeuu$num <- factor(eeuu$num, levels = c(0, 1))
europa$num <- factor(europa$num, levels = c(0, 1))
```

## Análisis exploratorio de datos

### Columnas numéricas de EEUU

Inicialmente, se pretende observar las variables de forma individual.

```{r var_individual, warning = FALSE}
# Edad separada por diagnóstico
ggplot(eeuu, aes(x = num, y = age, fill = num)) +
  geom_boxplot() +
  labs(x = 'Diagnóstico', y = 'Edad (Años)') +
  scale_x_discrete("Diagnóstico", labels = c("Sano", "Enfermo")) +
  theme_minimal() +
  theme(legend.position = "none")

# Presión arterial en reposo al momento de ingreso al hospital, separada por diagnóstico
ggplot(eeuu, aes(x = num, y = trestbps, fill = num)) +
  geom_boxplot() +
  labs(x = 'Diagnóstico', y = 'Presión arterial (Milímetros de mercurio)') +
  scale_x_discrete("Diagnóstico", labels = c("Sano", "Enfermo")) +
  theme_minimal() +
  theme(legend.position = "none")

# Colesterol separado por diagnóstico
ggplot(eeuu, aes(x = num, y = chol, fill = num)) +
  geom_boxplot() +
  labs(x = 'Diagnóstico', y = 'Colesterol (Miligramos por 100 mililitros)') +
  scale_x_discrete("Diagnóstico", labels = c("Sano", "Enfermo")) +
  theme_minimal() +
  theme(legend.position = "none")

# Máxima frecuencia cardíaca, separada por diagnóstico
ggplot(eeuu, aes(x = num, y = thalach, fill = num)) +
  geom_boxplot() +
  labs(x = 'Diagnóstico', y = 'Máxima frecuencia cardíaca') +
  scale_x_discrete("Diagnóstico", labels = c("Sano", "Enfermo")) +
  theme_minimal() +
  theme(legend.position = "none")

# Depresión del segmento ST inducida por el ejercicio en relación con el reposo
ggplot(eeuu, aes(x = num, y = oldpeak, fill = num)) +
  geom_boxplot() +
  labs(x = 'Diagnóstico', y = 'Depresión del segmento ST') +
  scale_x_discrete("Diagnóstico", labels = c("Sano", "Enfermo")) +
  theme_minimal() +
  theme(legend.position = "none")

# Ahora, se obtienen los porcentajes de vasos sanguineos coloreados por fluoroscopía, separados por diagnóstico
porcentajes_ca <- rep(0, 8)

# Se llenan los porcentajes con ciclos
for (i in 0:1) {
  for (j in 0:3) {
    porcentajes_ca[[(4 * i + 1 + j)]] <-
      mean((eeuu$ca == j) * (eeuu$num == i), na.rm = TRUE)
  }
}

# Se crea un DataFrame para graficar
clases_ca <-
  data.frame(
    "diagnostico" = c("0", "0", "0", "0", "1", "1", "1", "1"),
    "ca" = c(0, 1, 2, 3, 0, 1, 2, 3),
    "porcentajes" = porcentajes_ca
  )

# Gráfico de vasos sanguineos coloreados por fluoroscopía, separados por diagnóstico
ggplot(clases_ca, aes(x = ca, y = porcentajes, fill = diagnostico)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(
    name = "Diagnóstico",
    values = c("0" = "#006992",
               "1" = "#00BC7F"),
    labels = c("0" = "Sano",
               "1" = "Enfermo")
  ) +
  labs(x = "Vasos sanguineos coloreados",
       y = "Porcentaje") +
  theme_minimal()

# Se eliminan las variables innecesarias
rm(porcentajes_ca, clases_ca, i, j)
```

Una vez comparadas las variables individualmente, se procede a hacer comparaciones entre ellas.

```{r comparacion_variables, warning = FALSE}
# Comparación entre edad y presión arterial
ggplot(eeuu, aes(x = age, y = trestbps, color = num)) +
  geom_point() +
  scale_color_manual(
    name = "Diagnóstico",
    values = c("0" = "#006992",
               "1" = "#00BC7F"),
    labels = c("0" = "Sano",
               "1" = "Enfermo")
  ) +
  labs(x = "Edad",
       y = "Presión arterial (Milímetros de mercurio)") +
  theme_minimal()

# Comparación entre edad y colesterol
ggplot(eeuu, aes(x = age, y = chol, color = num)) +
  geom_point() +
  scale_color_manual(
    name = "Diagnóstico",
    values = c("0" = "#006992",
               "1" = "#00BC7F"),
    labels = c("0" = "Sano",
               "1" = "Enfermo")
  ) +
  labs(x = "Edad",
       y = "Colesterol (Miligramos por 100 mililitros)") +
  theme_minimal()

# Comparación entre edad y máxima frecuencia cardíaca
ggplot(eeuu, aes(x = age, y = thalach, color = num)) +
  geom_point() +
  scale_color_manual(
    name = "Diagnóstico",
    values = c("0" = "#006992",
               "1" = "#00BC7F"),
    labels = c("0" = "Sano",
               "1" = "Enfermo")
  ) +
  labs(x = "Edad",
       y = "Máxima frecuencia cardíaca") +
  theme_minimal()

# Comparación entre edad y depresión del segmento ST
ggplot(eeuu, aes(x = age, y = oldpeak, color = num)) +
  geom_point() +
  scale_color_manual(
    name = "Diagnóstico",
    values = c("0" = "#006992",
               "1" = "#00BC7F"),
    labels = c("0" = "Sano",
               "1" = "Enfermo")
  ) +
  labs(x = "Edad",
       y = "Depresión del segmento ST") +
  theme_minimal()

# Comparación entre presión arterial y colesterol
ggplot(eeuu, aes(x = trestbps, y = chol, color = num)) +
  geom_point() +
  scale_color_manual(
    name = "Diagnóstico",
    values = c("0" = "#006992",
               "1" = "#00BC7F"),
    labels = c("0" = "Sano",
               "1" = "Enfermo")
  ) +
  labs(x = "Presión arterial (Milímetros de mercurio)",
       y = "Colesterol (Miligramos por 100 mililitros)") +
  theme_minimal()

# Comparación entre presión arterial y máxima frecuencia cardíaca
ggplot(eeuu, aes(x = trestbps, y = thalach, color = num)) +
  geom_point() +
  scale_color_manual(
    name = "Diagnóstico",
    values = c("0" = "#006992",
               "1" = "#00BC7F"),
    labels = c("0" = "Sano",
               "1" = "Enfermo")
  ) +
  labs(x = "Presión arterial (Milímetros de mercurio)",
       y = "Máxima frecuencia cardíaca") +
  theme_minimal()

# Comparación entre presión arterial y máxima frecuencia cardíaca
ggplot(eeuu, aes(x = trestbps, y = oldpeak, color = num)) +
  geom_point() +
  scale_color_manual(
    name = "Diagnóstico",
    values = c("0" = "#006992",
               "1" = "#00BC7F"),
    labels = c("0" = "Sano",
               "1" = "Enfermo")
  ) +
  labs(x = "Presión arterial (Milímetros de mercurio)",
       y = "Depresión del segmento ST") +
  theme_minimal()

# Comparación entre colesterol y máxima frecuencia cardíaca
ggplot(eeuu, aes(x = chol, y = thalach, color = num)) +
  geom_point() +
  scale_color_manual(
    name = "Diagnóstico",
    values = c("0" = "#006992",
               "1" = "#00BC7F"),
    labels = c("0" = "Sano",
               "1" = "Enfermo")
  ) +
  labs(x = "Colesterol (Miligramos por 100 mililitros)",
       y = "Máxima frecuencia cardíaca") +
  theme_minimal()

# Comparación entre colesterol y 
ggplot(eeuu, aes(x = chol, y = oldpeak, color = num)) +
  geom_point() +
  scale_color_manual(
    name = "Diagnóstico",
    values = c("0" = "#006992",
               "1" = "#00BC7F"),
    labels = c("0" = "Sano",
               "1" = "Enfermo")
  ) +
  labs(x = "Colesterol (Miligramos por 100 mililitros)",
       y = "Depresión del segmento ST") +
  theme_minimal()
```

### Columnas numéricas de Europa

A

### Variables categóricas

A

### Varianzas y correlaciones

Primero se crean diferentes gráficos para visualizar el comportamiento de las varianzas de las variables presentes en las bases de datos.

```{r Varianzas, message = FALSE}
# Se crea una columna en cada base para diferenciar de qué región proviene cada observación
eeuu$region <- "EEUU"
europa$region <- "Europa"

# Se unen las dos bases de Estsados Unidos y Europa
df.total <- rbind(eeuu, europa)

# Se elimina la columna de región
eeuu <- subset(eeuu, select = -region)
europa <- subset(europa, select = -region)

# Gráfico de densidad de edades por región y nivel (num)
ggplot(df.total, aes(x = age, fill = factor(num))) +
  geom_density(alpha = 0.5) +
  facet_wrap( ~ region) +
  labs(
    x = "Edad",
    y = "Densidad",
    fill = "Diagnóstico"
  ) +
  theme_minimal()

# Gráfico de cajas para comparar edades por región y nivel (num)
ggplot(df.total, aes(x = region, y = age, fill = region)) +
  geom_boxplot() +
  facet_grid( ~ num) +
  labs(
    x = "Región",
    y = "Edad",
    fill = "Región"
  ) +
  theme_minimal()

# Se guardan los nombres de las columnas numéricas de las bases
cols.num <- names(eeuu)[sapply(eeuu, is.numeric)]

# Se calcula la varianza de las columnas numéricas en las bases, ignorando los NA
vars.eeuu <- sapply(eeuu[, cols.num], var, na.rm = TRUE)
vars.europa <- sapply(europa[, cols.num], var, na.rm = TRUE)

# Se crea un DataFrame con el nombre de la variable y las varianzas correspondientes a cada región
df.var <- data.frame(variable = cols.num,
                     EEUU = vars.eeuu,
                     Europa = vars.europa,
                     row.names = NULL)

# Se redondean las varianzas a dos decimales y se ordena el DataFrame descendientemente según la varianza en EEUU
df.tabla <- df.var %>%
  mutate(across(c(EEUU, Europa), \(x) round(x, digits = 2))) %>%
  arrange(desc(EEUU))

# Se genera la tabla resultante
kable(df.tabla, caption = "Varianzas de las covariables por región",
      align = "lcc")

# Se eliminan las variables innecesarias
rm(df.var, df.tabla, vars.eeuu, vars.europa)
```

Seguidamente, se procede a observar las correlaciones de Pearson de estas variables.

```{r Correlaciones}

```


